/*!
 * EasyWechat.js v1.6.1
 * (c) 2017-2019 Hpyer
 * Released under the MIT License.
 */
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function t(e){return new Promise(function(t,n){function i(a,c){try{var s=e[c?"throw":"next"](a)}catch(e){return void n(e)}s.done?t(s.value):Promise.resolve(s.value).then(i,r)}function r(e){i(e,1)}i()})}var n=e(require("merge")),i=e(require("request")),r=e(require("body")),a=e(require("url")),c=e(require("qs")),s=e(require("fs")),o=e(require("path")),u=e(require("wechat-crypto")),l=require("xml2js");const d=function(){let e=arguments;return e[0]="NodeEasywechat: "+e[0],console.log.apply(null,arguments)},p=function(){return parseInt((new Date).getTime()/1e3)},f=function(e=16){let t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n="";for(let i=0;i<e;i++)n+=t.charAt(Math.floor(Math.random()*t.length));return n},y=function(e){if(!e)return e;if("object"!=typeof e)return e;let t=new Object;for(let n in e)t[n]=y(e[n]);return t},g=function(){let e=arguments;if(0==e.length)return null;let t=y(e[0]);if(1==e.length)return t;for(let n=1;n<e.length;n++)if(e[n]&&"object"==typeof e[n])for(let i in e[n])t[i]=e[n][i];return t},m=require("crypto"),h=function(e,t="sha1"){return m.createHash(t).update(e).digest("hex")},_=function(e,t,n="sha256"){return m.createHmac(n,t).update(e).digest("hex")},b=function(e,t="sha1",n=""){let i="",r="",a=Object.keys(e);a=a.sort();for(let t=0;t<a.length;t++)"sign"!=a[t]&&e[a[t]]&&(i+=r+a[t]+"="+e[a[t]],r="&");n&&(i+="&key="+n);let c="";switch(t=t.toLowerCase()){case"sha1":case"md5":c=h(i,t);break;case"hmac-sha256":case"hmac_sha256":t=t.replace(/^hmac[\-|_]/i,""),c=_(i,n,t)}return(c+"").toUpperCase()},q=e=>"[object String]"==Object.prototype.toString.call(e),I=e=>"[object Array]"==Object.prototype.toString.call(e),$=e=>"[object Number]"==Object.prototype.toString.call(e),S=e=>"[object Object]"==Object.prototype.toString.call(e);class w{constructor(e,t){this.$req=e,this.$res=t}getMethod(){return this.$req?this.$req.method:{}}getQuery(){return this.$req?a.parse(this.$req.url,!0).query:{}}_readBody(){return new Promise((e,t)=>{r(this.$req,(n,i)=>{n?t(n):e(i)})}).catch(e=>{d("app_server._readBody()",e)})}getBody(){return t(function*(){return this.$req?yield this._readBody():""}.call(this))}_initResponseOptions(e={}){return e.status=e.status||200,e.contentType=e.contentType||"text/html",e.headers=e.headers||{},e.headers["Content-Type"]=e.contentType,e}sendResponse(e,t={}){if(!this.$res)return!1;t=this._initResponseOptions(t),this.$res.writeHead(t.status,t.headers),this.$res.end(e)}}class k extends w{constructor(e){super(e.req,e.res),this.$ctx=e}sendResponse(e,t={}){if(!this.$ctx)return!1;t=this._initResponseOptions(t),this.$ctx.status=t.status;for(let e in t.headers)this.$ctx.set(e,t.headers[e]);this.$ctx.body=e}}class P extends w{constructor(e,t){super(e,t)}sendResponse(e,t={}){if(!this.$res)return!1;t=this._initResponseOptions(t),this.$res.status(t.status).set(t.headers).send(e)}}const A={appKey:"",appSecret:""};var E=null;class U{constructor(e={}){if(this.$config=n({},A,e),!this.$config.appKey&&!this.$config.mini_program.appId)throw new Error("\u672a\u586b\u5199appKey");if(!this.$config.appSecret&&!this.$config.mini_program.appSecret)throw new Error("\u672a\u586b\u5199appSecret");E=this,this.$plugins.forEach(e=>{this[e].init(this)})}setAppServerDefault(e,t){this.$config.app=new w(e,t)}setAppServerKoa2(e){this.$config.app=new k(e)}setAppServerExpress(e,t){this.$config.app=new P(e,t)}}U.prototype.requestGet=(e=>new Promise((t,n)=>{i({method:"GET",uri:e},function(e,i,r){if(e)n(e);else{try{r=JSON.parse(r)}catch(e){}t(r)}})})),U.prototype.requestFile=(e=>new Promise((t,n)=>{i({method:"GET",uri:e,encoding:"binary"},function(e,i,r){if(e)n(e);else{try{let e=Buffer.from(r,"binary");r=JSON.parse(e.toString())}catch(e){}t(r)}})})),U.prototype.requestPost=((e,t=null,n=!0)=>new Promise((r,a)=>{i({method:"POST",uri:e,json:n,body:t},function(e,t,n){e?a(e):r(n)})})),U.prototype.requestForm=((e,t=null)=>new Promise((n,r)=>{i({method:"POST",uri:e,formData:t},function(e,t,i){if(e)r(e);else{try{i=JSON.parse(i)}catch(e){}n(i)}})})),U.prototype.buildApiUrl=(e=>t(function*(){let t=yield E.access_token.getToken();return e+"?access_token="+t}())),U.prototype.$plugins=[],U.registPlugin=((e,t)=>{U.prototype[e]=t,U.prototype.$plugins.push(e)});var x={EasyWechat:U,getInstance:()=>E};const v="https://open.weixin.qq.com/connect/oauth2/authorize",T="https://open.weixin.qq.com/connect/qrconnect",M="https://api.weixin.qq.com/sns/oauth2/access_token",C="https://api.weixin.qq.com/sns/userinfo";class N{constructor(){this.id="",this.nickname="",this.name="",this.avatar="",this.original={},this.token={}}}const j=function(e){},D=function(e=""){let t=x.getInstance();if(!t.$config.oauth)return"";if(!t.$config.oauth.scope)throw new Error("\u672a\u586b\u5199\u6388\u6743scope");if(!t.$config.oauth.redirect)throw new Error("\u672a\u586b\u5199\u6388\u6743\u56de\u8c03\u5730\u5740");let n=t.$config.oauth.redirect;if("http://"!=n.substr(0,7)&&"https://"!=n.substr(0,8))throw new Error("\u8bf7\u586b\u5199\u5b8c\u6574\u7684\u56de\u8c03\u5730\u5740\uff0c\u4ee5\u201chttp://\u201d\u6216\u201chttps://\u201d\u5f00\u5934");let i=v;"snsapi_login"==t.$config.oauth.scope&&(i=T);let r={appid:t.$config.appKey,redirect_uri:n,response_type:"code",scope:t.$config.oauth.scope};return e&&(r.state=e),i+"?"+c.stringify(r)+"#wechat_redirect"},R=function(e){return t(function*(){let t=yield O(e);return"snsapi_base"!=x.getInstance().$config.oauth.scope&&(t=yield F(t)),t}())},O=function(e){return t(function*(){let t=x.getInstance(),n={appid:t.$config.appKey,secret:t.$config.appSecret,code:e,grant_type:"authorization_code"},i=M+"?"+c.stringify(n),r=yield t.requestGet(i),a=new N;return a.id=r.openid,a.token=r,a}())},F=function(e){return t(function*(){let t={access_token:e.token.access_token,openid:e.id,lang:"zh_CN"},n=C+"?"+c.stringify(t),i=yield x.getInstance().requestGet(n);return i.errcode?(d("oauth.fetchUserInfo()",i),e):(e.id=i.openid,e.nickname=i.nickname,e.name=i.nickname,e.avatar=i.headimgurl,e.original=i,e)}())};var K={init:function(e){},redirect:function(e=""){let t=x.getInstance();if(!t.$config.oauth)return"";if(!t.$config.oauth.scope)throw new Error("\u672a\u586b\u5199\u6388\u6743scope");if(!t.$config.oauth.redirect)throw new Error("\u672a\u586b\u5199\u6388\u6743\u56de\u8c03\u5730\u5740");let n=t.$config.oauth.redirect;if("http://"!=n.substr(0,7)&&"https://"!=n.substr(0,8))throw new Error("\u8bf7\u586b\u5199\u5b8c\u6574\u7684\u56de\u8c03\u5730\u5740\uff0c\u4ee5\u201chttp://\u201d\u6216\u201chttps://\u201d\u5f00\u5934");let i=v;"snsapi_login"==t.$config.oauth.scope&&(i=T);let r={appid:t.$config.appKey,redirect_uri:n,response_type:"code",scope:t.$config.oauth.scope};return e&&(r.state=e),i+"?"+c.stringify(r)+"#wechat_redirect"},user:function(e){return t(function*(){let t=yield O(e);return"snsapi_base"!=x.getInstance().$config.oauth.scope&&(t=yield F(t)),t}())}};class W{constructor(){this.$options={}}fetch(e){return t(null)}contains(e){return t(!0)}save(e,n=null,i=0){return t(!0)}delete(e){return t(!0)}}class J extends W{constructor(){super(),this.$datas={}}fetch(e){return t(function*(){return!this.contains(e)||this.$datas[e].lifeTime>0&&this.$datas[e].lifeTime<p()?null:this.$datas[e].data}.call(this))}contains(e){return t(function*(){return"object"==typeof this.$datas[e]}.call(this))}save(e,n=null,i=0){return t(function*(){let t={data:n,lifeTime:i>0?i+p():0};return this.$datas[e]=t,!0}.call(this))}delete(e){return t(function*(){return delete this.$datas[e],!0}.call(this))}}class G extends W{constructor(e){super();let t={path:"",dirMode:511,fileMode:438,ext:".cache"};this.$options=g(t,e),this.$options.path=o.resolve(this.$options.path);try{s.accessSync(this.$options.path,s.constants.R_OK&s.constants.W_OK)}catch(e){try{s.mkdirSync(this.$options.path,this.$options.dirMode)}catch(e){d("\u65e0\u6cd5\u521b\u5efa\u7f13\u5b58\u76ee\u5f55\uff1a"+this.$options.path,e)}}}getCacheFile(e){return this.$options.path+"/"+e+this.$options.ext}fetch(e){return t(function*(){let t=null,n=this.getCacheFile(e);try{let e=JSON.parse(s.readFileSync(n,{encoding:"utf-8",flag:"r"}));t=e.lifeTime>0&&e.lifeTime<p()?null:e.data}catch(e){d("\u65e0\u6cd5\u8bfb\u53d6\u7f13\u5b58\u6587\u4ef6\uff1a"+n,e),t=null}return t}.call(this))}contains(e){return t(function*(){let t=this.getCacheFile(e);try{s.accessSync(t,s.constants.R_OK&s.constants.W_OK)}catch(e){return!1}return!0}.call(this))}save(e,n=null,i=0){return t(function*(){let t=this.getCacheFile(e);try{let e={data:n,lifeTime:i>0?i+p():0};s.writeFileSync(t,JSON.stringify(e),{mode:this.$options.fileMode,encoding:"utf-8",flag:"w"})}catch(e){return d("\u65e0\u6cd5\u5199\u5165\u7f13\u5b58\u6587\u4ef6\uff1a"+t,e),!1}return!0}.call(this))}delete(e){return t(function*(){let t=this.getCacheFile(e);try{s.unlinkSync(t)}catch(e){return d("\u65e0\u6cd5\u5220\u9664\u7f13\u5b58\u6587\u4ef6\uff1a"+t,e),!1}return!0}.call(this))}}var B=Object.freeze({CacheInterface:W,MemoryCache:J,FileCache:G});const L=function(e){if(!e.$config.cache)switch(e.$config.cache_driver){case"file":e.$config.cache=new G(e.$config.cache_options);break;case"memory":default:e.$config.cache=new J}},Q=function(e){e&&"function"==typeof e.fetch&&"function"==typeof e.contains&&"function"==typeof e.save&&"function"==typeof e.delete&&(x.getInstance().$config.cache=e)};var H={init:function(e){if(!e.$config.cache)switch(e.$config.cache_driver){case"file":e.$config.cache=new G(e.$config.cache_options);break;case"memory":default:e.$config.cache=new J}},setCache:function(e){e&&"function"==typeof e.fetch&&"function"==typeof e.contains&&"function"==typeof e.save&&"function"==typeof e.delete&&(x.getInstance().$config.cache=e)}};const V="https://api.weixin.qq.com/cgi-bin/token",z=function(e){e.$config.access_token_cache_key=e.$config.access_token_cache_key||"NODE_EASYWECHAT_ACCESS_TOKEN"},Y=function(){return t(function*(){let e=x.getInstance(),t={appid:e.$config.appKey,secret:e.$config.appSecret,grant_type:"client_credential"},n=V+"?"+c.stringify(t);return yield e.requestGet(n)}())},X=function(e=!1){return t(function*(){let t=x.getInstance(),n=yield t.$config.cache.fetch(t.$config.access_token_cache_key);if(e||!n){let e=yield Y();yield Z(e.access_token,e.expires_in),n=e.access_token}return n}())},Z=function(e,n=7200){return t(function*(){let t=x.getInstance();d("write AccessToken: ",t.$config.access_token_cache_key,e,n),yield t.$config.cache.save(t.$config.access_token_cache_key,e,n)}())};var ee={init:function(e){e.$config.access_token_cache_key=e.$config.access_token_cache_key||"NODE_EASYWECHAT_ACCESS_TOKEN"},getToken:function(e=!1){return t(function*(){let t=x.getInstance(),n=yield t.$config.cache.fetch(t.$config.access_token_cache_key);if(e||!n){let e=yield Y();yield Z(e.access_token,e.expires_in),n=e.access_token}return n}())},setToken:Z};const te="https://api.weixin.qq.com/cgi-bin/ticket/getticket",ne=function(e){e.$config.jssdk_cache_key=e.$config.jssdk_cache_key||"NODE_EASYWECHAT_JSSKD_TICKET"};var ie="";const re=function(e){ie=e},ae=function(){return t(function*(){let e=x.getInstance(),t={access_token:yield e.access_token.getToken(),type:"jsapi"},n=te+"?"+c.stringify(t);return yield e.requestGet(n)}())},ce=function(e=!1){return t(function*(){let t=x.getInstance(),n=yield t.$config.cache.fetch(t.$config.jssdk_cache_key);if(e||!n){let e=yield ae();d("write JSSDK: ",t.$config.jssdk_cache_key,e.ticket,e.expires_in),yield t.$config.cache.save(t.$config.jssdk_cache_key,e.ticket,e.expires_in),n=e.ticket}return n}())},se=function(e,n=!1,i=!0){return t(function*(){let t=x.getInstance(),r=yield ce(),a=ie,c=f(),s=p(),o=b({jsapi_ticket:r,noncestr:c,timestamp:s,url:a}),u={debug:n,appId:t.$config.appKey,timestamp:s,nonceStr:c,signature:o,url:a,jsApiList:e};return ie="",i?JSON.stringify(u):u}())};var oe={init:function(e){e.$config.jssdk_cache_key=e.$config.jssdk_cache_key||"NODE_EASYWECHAT_JSSKD_TICKET"},setUrl:function(e){ie=e},getTicket:ce,config:function(e,n=!1,i=!0){return t(function*(){let t=x.getInstance(),r=yield ce(),a=ie,c=f(),s=p(),o=b({jsapi_ticket:r,noncestr:c,timestamp:s,url:a}),u={debug:n,appId:t.$config.appKey,timestamp:s,nonceStr:c,signature:o,url:a,jsApiList:e};return ie="",i?JSON.stringify(u):u}())}};class ue{constructor(e){this.dataParams={ToUserName:"",FromUserName:"",CreateTime:p(),MsgType:""},this.json=null,this.data="","object"==typeof e?this.json=e:this.data=e}setAttribute(e,t){this.dataParams[e]=t}formatData(){return"<xml>"+this._formatData(this.dataParams)+"</xml>"}_formatData(e){if("object"==typeof e){let t="";for(let n in e)if(I(e[n]))for(let i=0;i<e[n].length;i++)t+=`<${n}>${this._formatData(e[n][i])}</${n}>`;else t+=`<${n}>${this._formatData(e[n])}</${n}>`;return t}return q(e)?"<![CDATA["+e+"]]>":e}getData(){return this.json?JSON.stringify(this.json):(this.data||(this.data=this.formatData()),this.data)}}class le extends ue{constructor(e){super(""),this.dataParams={},this.dataParams.Encrypt=e.encrypt||"",this.dataParams.MsgSignature=e.sign||"",this.dataParams.TimeStamp=e.timestamp||p(),this.dataParams.Nonce=e.nonce||""}content(e){this.dataParams.Content=e}}class de extends ue{constructor(e){super(""),this.dataParams.MsgType="text",this.dataParams.Content=e.content||""}content(e){this.dataParams.Content=e}}class pe extends ue{constructor(e){super(""),this.dataParams.MsgType="image",this.dataParams.Image={MediaId:e.media_id||""}}mediaId(e){this.dataParams.Image.MediaId=e}}class fe extends ue{constructor(e){super(""),this.dataParams.MsgType="voice",this.dataParams.Voice={MediaId:e.media_id||""}}mediaId(e){this.dataParams.Voice.MediaId=e}}class ye extends ue{constructor(e){super(""),this.dataParams.MsgType="video",this.dataParams.Video={MediaId:e.media_id||"",Title:e.title||"",Description:e.description||""}}mediaId(e){this.dataParams.Video.MediaId=e}title(e){this.dataParams.Video.Title=e}description(e){this.dataParams.Video.Description=e}}class ge extends ue{constructor(e){super(""),this.dataParams.MsgType="music",this.dataParams.Music={MediaId:e.media_id||"",Title:e.title||"",Description:e.description||"",MusicUrl:e.music_url||"",HQMusicUrl:e.hq_music_url||"",ThumbMediaId:e.thumb_media_id||""}}mediaId(e){this.dataParams.Music.MediaId=e}title(e){this.dataParams.Music.Title=e}description(e){this.dataParams.Music.Description=e}musicUrl(e){this.dataParams.Music.MusicUrl=e}hqMusicurl(e){this.dataParams.Music.HQMusicUrl=e}thumbMediaId(e){this.dataParams.Music.ThumbMediaId=e}}class me extends ue{constructor(e){super(""),this.dataParams.MsgType="news",this.dataParams.ArticleCount=1,this.dataParams.Articles={item:{Title:e.title||"",Description:e.description||"",Url:e.url||"",PicUrl:e.image||""}}}title(e){this.dataParams.Articles.item.Title=e}description(e){this.dataParams.Articles.item.Description=e}url(e){this.dataParams.Articles.item.Url=e}picUrl(e){this.dataParams.Articles.item.PicUrl=e}}var he=Object.freeze({Raw:ue,Encrypt:le,Text:de,Image:pe,Voice:fe,Video:ye,Music:ge,News:me});const _e=function(e){be=function(){}};let be,qe;const Ie=function(e){"function"!=typeof e&&(e=function(){}),be=e},$e=function(e){let t=[],n=null;for(let i in e)"news"==e[i].dataParams.MsgType&&(n=e[i],t.push(e[i].dataParams.Articles.item));return t.length>0&&n&&(n.dataParams.ArticleCount=t.length,n.dataParams.Articles.item=t),n},Se=function(){return t(function*(){let e=x.getInstance(),t=e.$config.app;if(!t)throw new Error("\u672a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u5e94\u7528\u670d\u52a1\u5668");let n=null;if(e.$config.aesKey&&(n=new u(e.$config.token,e.$config.aesKey,e.$config.appKey)),"GET"==t.getMethod()){let r=t.getQuery();if(!(r.signature&&r.echostr&&r.timestamp&&r.nonce))return void t.sendResponse("Hello node-easywechat");let a;if(n)a=n.getSignature(r.timestamp||"",r.nonce||"",r.encrypt||"");else{var i=[e.$config.token,r.timestamp||"",r.nonce||"",r.encrypt||""].sort();a=h(i.join(""),"sha1")}a===r.signature?t.sendResponse(r.echostr):t.sendResponse("fail")}else{let e=yield t.getBody();if(qe=yield we(e,n),be&&"function"==typeof be){let e=yield be(qe);if(!e||q(e)&&"SUCCESS"==e.toUpperCase())return void t.sendResponse("SUCCESS");let i=null;if((i=q(e)?new de({content:e}):I(e)?$e(e):e)&&"object"==typeof i){i.setAttribute("ToUserName",qe.FromUserName),i.setAttribute("FromUserName",qe.ToUserName);let e=i.getData();if(d("server.send().original",e),n&&qe._isEncrypt){e=n.encrypt(e);let t=p(),r=f(),a=n.getSignature(t,r,e);e=(i=new le({encrypt:e,sign:a,timestamp:t,nonce:r})).getData(),d("server.send().encrypt",e)}t.sendResponse(e)}}}}())},we=function(e,n=null){return t(function*(){return new Promise((i,r)=>{l.parseString(e,(e,a)=>t(function*(){if(e)r(e);else{let e;if(a&&a.xml){e={};for(let t in a.xml)e[t]=a.xml[t][0];if(e._isEncrypt=!1,e.Encrypt&&n){let t=n.decrypt(e.Encrypt);if(d("parseMessage.decrypted",t),!(e=yield we(t.message)))throw new Error("\u65e0\u6cd5\u89e3\u5bc6\u6d88\u606f\uff0c\u8bf7\u786e\u8ba4 AppId\u3001Token\u3001AESKey \u7b49\u662f\u5426\u6b63\u786e");e._isEncrypt=!0}}i(e)}}()))}).catch(e=>{d("server.parseMessage()",e)})}())},ke=function(){return qe};var Pe={init:function(e){be=function(){}},setMessageHandler:function(e){"function"!=typeof e&&(e=function(){}),be=e},serve:function(){return t(function*(){let e=x.getInstance(),t=e.$config.app;if(!t)throw new Error("\u672a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u5e94\u7528\u670d\u52a1\u5668");let n=null;if(e.$config.aesKey&&(n=new u(e.$config.token,e.$config.aesKey,e.$config.appKey)),"GET"==t.getMethod()){let r=t.getQuery();if(!(r.signature&&r.echostr&&r.timestamp&&r.nonce))return void t.sendResponse("Hello node-easywechat");let a;if(n)a=n.getSignature(r.timestamp||"",r.nonce||"",r.encrypt||"");else{var i=[e.$config.token,r.timestamp||"",r.nonce||"",r.encrypt||""].sort();a=h(i.join(""),"sha1")}a===r.signature?t.sendResponse(r.echostr):t.sendResponse("fail")}else{let e=yield t.getBody();if(qe=yield we(e,n),be&&"function"==typeof be){let e=yield be(qe);if(!e||q(e)&&"SUCCESS"==e.toUpperCase())return void t.sendResponse("SUCCESS");let i=null;if((i=q(e)?new de({content:e}):I(e)?$e(e):e)&&"object"==typeof i){i.setAttribute("ToUserName",qe.FromUserName),i.setAttribute("FromUserName",qe.ToUserName);let e=i.getData();if(d("server.send().original",e),n&&qe._isEncrypt){e=n.encrypt(e);let t=p(),r=f(),a=n.getSignature(t,r,e);e=(i=new le({encrypt:e,sign:a,timestamp:t,nonce:r})).getData(),d("server.send().encrypt",e)}t.sendResponse(e)}}}}())},getMessage:function(){return qe}};const Ae="https://api.weixin.qq.com/cgi-bin/message/template/send",Ee="https://api.weixin.qq.com/cgi-bin/template/get_industry",Ue="https://api.weixin.qq.com/cgi-bin/template/api_set_industry",xe="https://api.weixin.qq.com/cgi-bin/template/api_add_template",ve="https://api.weixin.qq.com/cgi-bin/template/get_all_private_template",Te="https://api.weixin.qq.com/cgi-bin/template/del_private_template",Me=function(e){Ne=new Ce};class Ce{constructor(){this.reset()}}Ce.prototype.reset=function(){this.touser="",this.template_id="",this.url="",this.miniprogram={},this.data=[]};let Ne=null;const je=function(e){return Ne.touser=e,this},De=function(e){return Ne.template_id=e,this},Re=function(e){return Ne.url=e,this},Oe=function(e){return Ne.data=Fe(e),this},Fe=function(e){let t={};for(let n in e){let i=e[n];"object"==typeof i?void 0!==i.length?t[n]={value:i[0],color:i[1]}:t[n]=i:t[n]={value:i}}return t},Ke=function(e=null){return t(function*(){if(e?e.data&&(e.data=Fe(e.data)):e={},e=n({},Ne,e),Ne.reset(),!e.touser)throw new Error("\u7528\u6237openid\u4e3a\u7a7a");if(!e.template_id)throw new Error("\u6a21\u677fid\u4e3a\u7a7a");let t=x.getInstance(),i=yield t.buildApiUrl(Ae);return yield t.requestPost(i,e)}())},We=function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(Ee);return yield e.requestPost(t)}())},Je=function(e,n){return t(function*(){let t=x.getInstance(),i=yield t.buildApiUrl(Ue),r={industry_id1:e,industry_id2:n};return yield t.requestPost(i,r)}())},Ge=function(e){return t(function*(){let t=x.getInstance(),n=yield t.buildApiUrl(xe),i={template_id_short:e};return yield t.requestPost(n,i)}())},Be=function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(ve);return yield e.requestPost(t)}())},Le=function(e){return t(function*(){let t=x.getInstance(),n=yield t.buildApiUrl(Te),i={template_id:e};return yield t.requestPost(n,i)}())};var Qe={init:function(e){Ne=new Ce},to:je,withTo:je,andTo:je,receiver:je,withReceiver:je,andhReceiver:je,uses:De,withUses:De,andUses:De,template:De,withTemplate:De,andTemplate:De,templateId:De,withTemplateId:De,andTemplateId:De,url:Re,withUrl:Re,andUrl:Re,link:Re,withLink:Re,andLink:Re,linkTo:Re,withLinkTo:Re,andLinkTo:Re,data:Oe,withData:Oe,andData:Oe,send:function(e=null){return t(function*(){if(e?e.data&&(e.data=Fe(e.data)):e={},e=n({},Ne,e),Ne.reset(),!e.touser)throw new Error("\u7528\u6237openid\u4e3a\u7a7a");if(!e.template_id)throw new Error("\u6a21\u677fid\u4e3a\u7a7a");let t=x.getInstance(),i=yield t.buildApiUrl(Ae);return yield t.requestPost(i,e)}())},getIndustry:function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(Ee);return yield e.requestPost(t)}())},setIndustry:function(e,n){return t(function*(){let t=x.getInstance(),i=yield t.buildApiUrl(Ue),r={industry_id1:e,industry_id2:n};return yield t.requestPost(i,r)}())},addTemplate:function(e){return t(function*(){let t=x.getInstance(),n=yield t.buildApiUrl(xe),i={template_id_short:e};return yield t.requestPost(n,i)}())},getPrivateTemplates:function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(ve);return yield e.requestPost(t)}())},deletePrivateTemplate:function(e){return t(function*(){let t=x.getInstance(),n=yield t.buildApiUrl(Te),i={template_id:e};return yield t.requestPost(n,i)}())}};const He="https://api.weixin.qq.com/cgi-bin/qrcode/create",Ve="https://mp.weixin.qq.com/cgi-bin/showqrcode",ze=function(e){},Ye=function(e,n=null){return t(function*(){((n=parseInt(n))<=0||n>2592e3)&&(n=2592e3);let t="";"string"==typeof e?(e={scene_str:e},t="QR_STR_SCENE"):(e={scene_id:e},t="QR_SCENE");let i={expire_seconds:n,action_name:t,action_info:{scene:e}},r=x.getInstance(),a=yield r.buildApiUrl(He);return yield r.requestPost(a,i)}())},Xe=function(e){return t(function*(){let t="";"string"==typeof e?(e={scene_str:e},t="QR_LIMIT_STR_SCENE"):(e={scene_id:e},t="QR_LIMIT_SCENE");let n={action_name:t,action_info:{scene:e}},i=x.getInstance(),r=yield i.buildApiUrl(He);return yield i.requestPost(r,n)}())},Ze=function(e){return t(function*(){let t=Ve+"?ticket="+e;return yield x.getInstance().requestFile(t)}())};var et={init:function(e){},temporary:function(e,n=null){return t(function*(){((n=parseInt(n))<=0||n>2592e3)&&(n=2592e3);let t="";"string"==typeof e?(e={scene_str:e},t="QR_STR_SCENE"):(e={scene_id:e},t="QR_SCENE");let i={expire_seconds:n,action_name:t,action_info:{scene:e}},r=x.getInstance(),a=yield r.buildApiUrl(He);return yield r.requestPost(a,i)}())},forever:function(e){return t(function*(){let t="";"string"==typeof e?(e={scene_str:e},t="QR_LIMIT_STR_SCENE"):(e={scene_id:e},t="QR_LIMIT_SCENE");let n={action_name:t,action_info:{scene:e}},i=x.getInstance(),r=yield i.buildApiUrl(He);return yield i.requestPost(r,n)}())},url:function(e){return t(function*(){let t=Ve+"?ticket="+e;return yield x.getInstance().requestFile(t)}())}};const tt="https://api.weixin.qq.com/cgi-bin/user/info",nt="https://api.weixin.qq.com/cgi-bin/user/info/batchget",it="https://api.weixin.qq.com/cgi-bin/user/get",rt="https://api.weixin.qq.com/cgi-bin/user/info/updateremark",at="https://api.weixin.qq.com/cgi-bin/tags/members/getblacklist",ct="https://api.weixin.qq.com/cgi-bin/tags/members/batchblacklist",st="https://api.weixin.qq.com/cgi-bin/tags/members/batchunblacklist";class ot{constructor(){this.id="",this.nickname="",this.name="",this.avatar="",this.original={},this.token={}}}const ut=function(e){},lt=function(e,n="zh_CN"){return t(function*(){let t=x.getInstance(),i=yield t.buildApiUrl(tt);i+="&openid="+e+"&lang="+n;let r=yield t.requestGet(i),a=new ot;return a.id=r.openid,a.nickname=r.nickname,a.name=r.nickname,a.avatar=r.headimgurl,a.original=r,a}())},dt=function(e){return t(function*(){let t=x.getInstance(),n={user_list:e},i=yield t.buildApiUrl(nt);return yield t.requestPost(i,n)}())},pt=function(e=null){return t(function*(){let t=x.getInstance(),n=yield t.buildApiUrl(it);return e&&(n+="&next_openid="+e),yield t.requestGet(n)}())},ft=function(e,n){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(rt);return yield e.requestPost(t)}())},yt=function(e){return t(function*(){let t=x.getInstance(),n={};e&&(n.begin_openid=e);let i=yield t.buildApiUrl(at);return yield t.requestPost(i,n)}())},gt=function(e){return t(function*(){let t=x.getInstance(),n={openid_list:e},i=yield t.buildApiUrl(ct);return yield t.requestPost(i,n)}())},mt=function(e){return t(function*(){let t=x.getInstance(),n={openid_list:e},i=yield t.buildApiUrl(st);return yield t.requestPost(i,n)}())},ht=function(e){return t(function*(){return yield gt([e])}())},_t=function(e){return t(function*(){return yield mt([e])}())};var bt={init:function(e){},get:function(e,n="zh_CN"){return t(function*(){let t=x.getInstance(),i=yield t.buildApiUrl(tt);i+="&openid="+e+"&lang="+n;let r=yield t.requestGet(i),a=new ot;return a.id=r.openid,a.nickname=r.nickname,a.name=r.nickname,a.avatar=r.headimgurl,a.original=r,a}())},batchGet:function(e){return t(function*(){let t=x.getInstance(),n={user_list:e},i=yield t.buildApiUrl(nt);return yield t.requestPost(i,n)}())},lists:function(e=null){return t(function*(){let t=x.getInstance(),n=yield t.buildApiUrl(it);return e&&(n+="&next_openid="+e),yield t.requestGet(n)}())},remark:function(e,n){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(rt);return yield e.requestPost(t)}())},blacklist:function(e){return t(function*(){let t=x.getInstance(),n={};e&&(n.begin_openid=e);let i=yield t.buildApiUrl(at);return yield t.requestPost(i,n)}())},batchBlock:gt,batchUnblock:mt,block:function(e){return t(function*(){return yield gt([e])}())},unblock:function(e){return t(function*(){return yield mt([e])}())}};const qt="https://api.weixin.qq.com/cgi-bin/menu/get",It="https://api.weixin.qq.com/cgi-bin/get_current_selfmenu_info",$t="https://api.weixin.qq.com/cgi-bin/menu/create",St="https://api.weixin.qq.com/cgi-bin/menu/delete",wt=function(e){},kt=function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(qt);return yield e.requestPost(t)}())},Pt=function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(It);return yield e.requestPost(t)}())},At=function(e){return t(function*(){let t={button:e},n=x.getInstance(),i=yield n.buildApiUrl($t);return yield n.requestPost(i,t)}())},Et=function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(St);return yield e.requestPost(t)}())};var Ut={init:function(e){},all:function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(qt);return yield e.requestPost(t)}())},current:function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(It);return yield e.requestPost(t)}())},add:function(e){return t(function*(){let t={button:e},n=x.getInstance(),i=yield n.buildApiUrl($t);return yield n.requestPost(i,t)}())},destroy:function(){return t(function*(){let e=x.getInstance(),t=yield e.buildApiUrl(St);return yield e.requestPost(t)}())}};const xt="https://api.weixin.qq.com/cgi-bin/shorturl",vt=function(e){},Tt=function(e){return t(function*(){let t={action:"long2short",long_url:e},n=x.getInstance(),i=yield n.buildApiUrl(xt);return yield n.requestPost(i,t)}())};var Mt={init:function(e){},shorten:function(e){return t(function*(){let t={action:"long2short",long_url:e},n=x.getInstance(),i=yield n.buildApiUrl(xt);return yield n.requestPost(i,t)}())}};const Ct="https://api.mch.weixin.qq.com/pay/unifiedorder",Nt=function(e){},jt=function(e){let t="<xml>";for(let n in e)e[n]&&($(e[n])?t+=`<${n}>${e[n]}</${n}>`:S(e[n])?t+=`<${n}>${JSON.stringify(e[n])}</${n}>`:t+=`<${n}><![CDATA[${e[n]}]]></${n}>`);return t+="</xml>"},Dt=function(e){return t(function*(){let t=x.getInstance(),n=t.$config.payment,i={appid:t.$config.appKey,mch_id:n.merchantId,device_info:e.device_info||"WEB",nonce_str:f(16),body:e.body,detail:e.detail||"",attach:e.attach||"",out_trade_no:e.out_trade_no,fee_type:e.fee_type||"CNY",total_fee:e.total_fee,spbill_create_ip:e.spbill_create_ip,time_start:e.time_start||"",time_expire:e.time_expire||"",goods_tag:e.goods_tag||"",notify_url:e.notify_url||n.notifyUrl,trade_type:e.trade_type||"JSAPI",product_id:e.product_id||"",limit_pay:e.limit_pay||"",openid:e.openid||"",scene_info:e.scene_info||"",sign_type:e.sign_type||"MD5"};i.sign=b(i,i.sign_type,n.key);let r=jt(i),a=yield t.requestPost(Ct,r);return a=yield Ot(a),d("payment.prepare(): ",i,r,a),a}())},Rt=function(e){return t(function*(){let t=x.getInstance(),n=t.$config.app;if(!n)throw new Error("\u672a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u5e94\u7528\u670d\u52a1\u5668");let i=t.$config.payment,r=yield n.getBody(),a=yield Ot(r),c={return_code:"",return_msg:""};if(d("payment.handleNotify():",a),"SUCCESS"!==a.return_code)return c.return_code="SUCCESS",c.return_msg="return_code\u5f02\u5e38",n.sendResponse(jt(c));let s=b(a,"MD5",i.key);if(s!==a.sign)return d("payment.handleNotify(): invalid_sign",s,a.sign),c.return_code="FAIL",c.return_msg="\u7b7e\u540d\u9519\u8bef",n.sendResponse(jt(c));let o=!1;try{o=yield e(a,"SUCCESS"===a.result_code)}catch(e){o=!1}!0===o?(c.return_code="SUCCESS",c.return_msg=""):(c.return_code="FAIL",c.return_msg=o),n.sendResponse(jt(c))}())},Ot=function(e){return new Promise((t,n)=>{l.parseString(e,(e,i)=>{if(e)n(e);else{let e;if(i&&i.xml){e={};for(let t in i.xml)e[t]=i.xml[t][0]}t(e)}})}).catch(e=>{d("payment.parseMessage()",e)})},Ft=function(e,t=!1){let n=x.getInstance(),i={appId:n.$config.appKey,timeStamp:p()+"",nonceStr:f(16),package:"prepay_id="+e,signType:"MD5"};return i.paySign=b(i,"MD5",n.$config.payment.key),d("payment.configForPayment()",i),t&&(i=JSON.stringify(i)),i},Kt=function(e,t=!1){let n=x.getInstance(),i=p(),r={appId:n.$config.appKey,timeStamp:i,nonceStr:f(16),package:"prepay_id="+e,signType:"MD5"};return r.paySign=b(r,"MD5",n.$config.payment.key),delete r.appId,delete r.timeStamp,r.timestamp=i,d("payment.configForJSSDKPayment()",r),t&&(r=JSON.stringify(r)),r};var Wt={init:function(e){},prepare:function(e){return t(function*(){let t=x.getInstance(),n=t.$config.payment,i={appid:t.$config.appKey,mch_id:n.merchantId,device_info:e.device_info||"WEB",nonce_str:f(16),body:e.body,detail:e.detail||"",attach:e.attach||"",out_trade_no:e.out_trade_no,fee_type:e.fee_type||"CNY",total_fee:e.total_fee,spbill_create_ip:e.spbill_create_ip,time_start:e.time_start||"",time_expire:e.time_expire||"",goods_tag:e.goods_tag||"",notify_url:e.notify_url||n.notifyUrl,trade_type:e.trade_type||"JSAPI",product_id:e.product_id||"",limit_pay:e.limit_pay||"",openid:e.openid||"",scene_info:e.scene_info||"",sign_type:e.sign_type||"MD5"};i.sign=b(i,i.sign_type,n.key);let r=jt(i),a=yield t.requestPost(Ct,r);return a=yield Ot(a),d("payment.prepare(): ",i,r,a),a}())},handleNotify:function(e){return t(function*(){let t=x.getInstance(),n=t.$config.app;if(!n)throw new Error("\u672a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u5e94\u7528\u670d\u52a1\u5668");let i=t.$config.payment,r=yield n.getBody(),a=yield Ot(r),c={return_code:"",return_msg:""};if(d("payment.handleNotify():",a),"SUCCESS"!==a.return_code)return c.return_code="SUCCESS",c.return_msg="return_code\u5f02\u5e38",n.sendResponse(jt(c));let s=b(a,"MD5",i.key);if(s!==a.sign)return d("payment.handleNotify(): invalid_sign",s,a.sign),c.return_code="FAIL",c.return_msg="\u7b7e\u540d\u9519\u8bef",n.sendResponse(jt(c));let o=!1;try{o=yield e(a,"SUCCESS"===a.result_code)}catch(e){o=!1}!0===o?(c.return_code="SUCCESS",c.return_msg=""):(c.return_code="FAIL",c.return_msg=o),n.sendResponse(jt(c))}())},configForPayment:function(e,t=!1){let n=x.getInstance(),i={appId:n.$config.appKey,timeStamp:p()+"",nonceStr:f(16),package:"prepay_id="+e,signType:"MD5"};return i.paySign=b(i,"MD5",n.$config.payment.key),d("payment.configForPayment()",i),t&&(i=JSON.stringify(i)),i},configForJSSDKPayment:function(e,t=!1){let n=x.getInstance(),i=p(),r={appId:n.$config.appKey,timeStamp:i,nonceStr:f(16),package:"prepay_id="+e,signType:"MD5"};return r.paySign=b(r,"MD5",n.$config.payment.key),delete r.appId,delete r.timeStamp,r.timestamp=i,d("payment.configForJSSDKPayment()",r),t&&(r=JSON.stringify(r)),r}};const Jt="https://api.weixin.qq.com/cgi-bin/media/get",Gt="https://api.weixin.qq.com/cgi-bin/media/upload",Bt=function(e){},Lt=function(e){return t(function*(){let t,n=x.getInstance(),i=(yield n.buildApiUrl(Jt))+"&media_id="+e;try{t=yield n.requestFile(i)}catch(t){return d("material_temporary.getStream()",e,t),!1}return S(t)?t.video_url?yield n.requestFile(t.video_url):(d("material_temporary.getStream()",t),!1):t}())},Qt=function(e,n,i=""){return t(function*(){let t=yield Lt(e);if(!t)return!1;try{i=i||e+".jpg",s.writeFileSync(n+i,t,"binary")}catch(e){return d("material_temporary.download()",e),!1}return!0}())},Ht=function(e,n="image",i=null){return t(function*(){let t,r=x.getInstance(),a=(yield r.buildApiUrl(Gt))+"&type="+n;try{let c={media:s.createReadStream(e)};i&&(c=extendObj(c,i)),t=yield r.requestForm(a,c)}catch(t){return d("material_temporary.upload()",e,n,t),!1}return t.errcode?(d("material_temporary.upload()",e,n,t),!1):t}())},Vt=function(e){return t(function*(){return yield Ht(e,"image")}())},zt=function(e){return t(function*(){return yield Ht(e,"voice")}())},Yt=function(e,n,i){return t(function*(){let t={description:JSON.stringify({title:n||"",introduction:i||""})};return yield Ht(e,"video",t)}())},Xt=function(e){return t(function*(){return yield Ht(e,"thumb")}())};var Zt={init:function(e){},getStream:Lt,download:function(e,n,i=""){return t(function*(){let t=yield Lt(e);if(!t)return!1;try{i=i||e+".jpg",s.writeFileSync(n+i,t,"binary")}catch(e){return d("material_temporary.download()",e),!1}return!0}())},upload:Ht,uploadImage:function(e){return t(function*(){return yield Ht(e,"image")}())},uploadVoice:function(e){return t(function*(){return yield Ht(e,"voice")}())},uploadVideo:function(e,n,i){return t(function*(){let t={description:JSON.stringify({title:n||"",introduction:i||""})};return yield Ht(e,"video",t)}())},uploadThumb:function(e){return t(function*(){return yield Ht(e,"thumb")}())}};const en="https://api.weixin.qq.com/cgi-bin/material/get_material",tn="https://api.weixin.qq.com/cgi-bin/material/add_material",nn="https://api.weixin.qq.com/cgi-bin/material/del_material",rn="https://api.weixin.qq.com/cgi-bin/material/batchget_material",an="https://api.weixin.qq.com/cgi-bin/material/get_materialcount",cn="https://api.weixin.qq.com/cgi-bin/material/add_news",sn="https://api.weixin.qq.com/cgi-bin/material/update_news",on="https://api.weixin.qq.com/cgi-bin/media/uploadimg",un=function(e){},ln=function(e){return t(function*(){let t,n=x.getInstance(),i=(yield n.buildApiUrl(en))+"&media_id="+e;try{t=yield n.requestFile(i)}catch(t){return d("material.getMaterial()",e,t),!1}return S(t)&&t.errcode?(d("material.getMaterial()",e,t),!1):t}())},dn=function(e,n,i=""){return t(function*(){let t=yield get(e);if(!t)return!1;try{i=i||e+".jpg",s.writeFileSync(n+i,t,"binary")}catch(e){return d("material.download()",e),!1}return!0}())},pn=function(e,n="image",i=null){return t(function*(){let t,r=x.getInstance(),a=(yield r.buildApiUrl(tn))+"&type="+n;try{let c={media:s.createReadStream(e)};i&&(c=g(c,i)),t=yield r.requestForm(a,c)}catch(t){return d("material.upload()",e,n,t),!1}return t.errcode?(d("material.upload()",e,n,t),!1):t}())},fn=function(e){return t(function*(){return yield pn(e,"image")}())},yn=function(e){return t(function*(){return yield pn(e,"voice")}())},gn=function(e,n,i){return t(function*(){let t={description:JSON.stringify({title:n||"",introduction:i||""})};return yield pn(e,"video",t)}())},mn=function(e){return t(function*(){return yield pn(e,"thumb")}())},hn=function(e){return t(function*(){let t,n=x.getInstance(),i=yield n.buildApiUrl(nn);try{t=yield n.requestPost(i,{mediaId:e})}catch(t){return d("material.deleteMaterial()",e,t),!1}return t.errcode?(d("material.deleteMaterial()",e,t),!1):t}())},_n=function(e,n=0,i=20){return t(function*(){let t,r=x.getInstance(),a=yield r.buildApiUrl(rn);try{t=yield r.requestPost(a,{type:e,offset:n,count:i})}catch(t){return d("material.lists()",e,n,i,t),!1}return t.errcode?(d("material.lists()",e,n,i,t),!1):t}())},bn=function(){return t(function*(){let e,t=x.getInstance(),n=yield t.buildApiUrl(an);try{e=yield t.requestGet(n)}catch(e){return d("material.stats()",e),!1}return e.errcode?(d("material.stats()",e),!1):e}())},qn=function(e){return t(function*(){S(e)&&(e=[e]);let t,n=x.getInstance(),i=yield n.buildApiUrl(cn);try{t=yield n.requestPost(i,{articles:e})}catch(t){return d("material.uploadArticle()",e,t),!1}return t.errcode?(d("material.uploadArticle()",e,t),!1):t}())},In=function(e){return t(function*(){let t,n=x.getInstance(),i=yield n.buildApiUrl(on);try{let r={media:s.createReadStream(e)};t=yield n.requestForm(i,r)}catch(t){return d("material.uploadArticleImage()",e,type,t),!1}return t.errcode?(d("material.uploadArticleImage()",e,type,t),!1):t}())},$n=function(e,n,i=0){return t(function*(){S(n)&&(n=[n]);let t,r=x.getInstance(),a=yield r.buildApiUrl(sn);try{t=yield r.requestPost(a,{media_id:e,index:i,articles:n})}catch(t){return d("material.updateArticle()",e,n,i,t),!1}return t.errcode?(d("material.updateArticle()",e,n,i,t),!1):t}())};var Sn={init:function(e){},get:function(e){return t(function*(){let t,n=x.getInstance(),i=(yield n.buildApiUrl(en))+"&media_id="+e;try{t=yield n.requestFile(i)}catch(t){return d("material.getMaterial()",e,t),!1}return S(t)&&t.errcode?(d("material.getMaterial()",e,t),!1):t}())},download:function(e,n,i=""){return t(function*(){let t=yield get(e);if(!t)return!1;try{i=i||e+".jpg",s.writeFileSync(n+i,t,"binary")}catch(e){return d("material.download()",e),!1}return!0}())},upload:pn,uploadImage:function(e){return t(function*(){return yield pn(e,"image")}())},uploadVoice:function(e){return t(function*(){return yield pn(e,"voice")}())},uploadVideo:function(e,n,i){return t(function*(){let t={description:JSON.stringify({title:n||"",introduction:i||""})};return yield pn(e,"video",t)}())},uploadThumb:function(e){return t(function*(){return yield pn(e,"thumb")}())},delete:function(e){return t(function*(){let t,n=x.getInstance(),i=yield n.buildApiUrl(nn);try{t=yield n.requestPost(i,{mediaId:e})}catch(t){return d("material.deleteMaterial()",e,t),!1}return t.errcode?(d("material.deleteMaterial()",e,t),!1):t}())},lists:function(e,n=0,i=20){return t(function*(){let t,r=x.getInstance(),a=yield r.buildApiUrl(rn);try{t=yield r.requestPost(a,{type:e,offset:n,count:i})}catch(t){return d("material.lists()",e,n,i,t),!1}return t.errcode?(d("material.lists()",e,n,i,t),!1):t}())},stats:function(){return t(function*(){let e,t=x.getInstance(),n=yield t.buildApiUrl(an);try{e=yield t.requestGet(n)}catch(e){return d("material.stats()",e),!1}return e.errcode?(d("material.stats()",e),!1):e}())},uploadArticle:function(e){return t(function*(){S(e)&&(e=[e]);let t,n=x.getInstance(),i=yield n.buildApiUrl(cn);try{t=yield n.requestPost(i,{articles:e})}catch(t){return d("material.uploadArticle()",e,t),!1}return t.errcode?(d("material.uploadArticle()",e,t),!1):t}())},uploadArticleImage:function(e){return t(function*(){let t,n=x.getInstance(),i=yield n.buildApiUrl(on);try{let r={media:s.createReadStream(e)};t=yield n.requestForm(i,r)}catch(t){return d("material.uploadArticleImage()",e,type,t),!1}return t.errcode?(d("material.uploadArticleImage()",e,type,t),!1):t}())},updateArticle:function(e,n,i=0){return t(function*(){S(n)&&(n=[n]);let t,r=x.getInstance(),a=yield r.buildApiUrl(sn);try{t=yield r.requestPost(a,{media_id:e,index:i,articles:n})}catch(t){return d("material.updateArticle()",e,n,i,t),!1}return t.errcode?(d("material.updateArticle()",e,n,i,t),!1):t}())}};const wn=require("crypto"),kn="https://api.weixin.qq.com/sns/jscode2session",Pn="https://api.weixin.qq.com/cgi-bin/token",An=function(e){},En={getSessionKey:function(e){return t(function*(){let t=x.getInstance(),n={appid:t.$config.mini_program.appId,secret:t.$config.mini_program.appSecret,js_code:e,grant_type:"authorization_code"},i=kn+"?"+c.stringify(n);return yield t.requestGet(i)}())},getAccessToken:function(e=!1){return t(function*(){let t=x.getInstance(),n=yield t.$config.cache.fetch(t.$config.mini_program.access_token_cache_key);if(e||!n){let e={appid:t.$config.mini_program.appId,secret:t.$config.mini_program.appSecret,grant_type:"client_credential"},i=Pn+"?"+c.stringify(e),r=yield t.requestGet(i);d("write AccessToken: ",t.$config.mini_program.access_token_cache_key,r.access_token,r.expires_in),yield t.$config.cache.save(t.$config.mini_program.access_token_cache_key,r.access_token,r.expires_in),n=r.access_token}return n}())}},Un={decryptData:function(e,n,i){return t(function*(){let t=Buffer.from(e,"base64"),r=Buffer.from(i,"base64"),a=Buffer.from(n,"base64"),c=null;try{let e=wn.createDecipheriv("aes-128-cbc",t,a);e.setAutoPadding(!0),c=e.update(r,"binary","utf8"),c+=e.final("utf8"),c=JSON.parse(c);let n=x.getInstance();if(c.watermark.appid!==n.$config.mini_program.appId)throw new Error("Invaild AppId")}catch(e){return d("mini_program.encryptor.decryptData()",e),null}return c}())}};var xn={init:function(e){},auth:En,encryptor:Un};x.EasyWechat.registPlugin("oauth",K),x.EasyWechat.registPlugin("cache",H),x.EasyWechat.registPlugin("access_token",ee),x.EasyWechat.registPlugin("jssdk",oe),x.EasyWechat.registPlugin("server",Pe),x.EasyWechat.registPlugin("notice",Qe),x.EasyWechat.registPlugin("qrcode",et),x.EasyWechat.registPlugin("user",bt),x.EasyWechat.registPlugin("menu",Ut),x.EasyWechat.registPlugin("url",Mt),x.EasyWechat.registPlugin("payment",Wt),x.EasyWechat.registPlugin("material_temporary",Zt),x.EasyWechat.registPlugin("material",Sn),x.EasyWechat.registPlugin("mini_program",xn),x.EasyWechat.Cache={};for(let e in B)x.EasyWechat.Cache[e]=B[e];x.EasyWechat.Message={};for(let e in he)x.EasyWechat.Message[e]=he[e];var vn=x.EasyWechat;module.exports=vn;