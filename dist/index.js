/*!
 * EasyWechat.js v1.3.5
 * (c) 2017-2018 Hpyer
 * Released under the MIT License.
 */
"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}function e(t){return new Promise(function(e,n){function i(s,o){try{var c=t[o?"throw":"next"](s)}catch(t){return void n(t)}c.done?e(c.value):Promise.resolve(c.value).then(i,r)}function r(t){i(t,1)}i()})}function n(t,e){return e={exports:{}},t(e,e.exports),e.exports}var i=t(require("merge")),r=t(require("request")),s=t(require("body")),o=t(require("url")),c=t(require("qs")),a=t(require("fs")),u=t(require("path")),l=t(require("crypto-js")),d=require("xml2js");class f{constructor(t,e){this.$req=t,this.$res=e}getMethod(){return this.$req?this.$req.method:{}}getQuery(){return this.$req?o.parse(this.$req.url,!0).query:{}}_readBody(){return new Promise((t,e)=>{s(this.$req,(n,i)=>{n?e(n):t(i)})}).catch(t=>{console.log("app_server._readBody()",t)})}getBody(){return e(function*(){return this.$req?yield this._readBody():""}.call(this))}_initResponseOptions(t={}){return t.status=t.status||200,t.contentType=t.contentType||"text/html",t.headers=t.headers||{},t.headers["Content-Type"]=t.contentType,t}sendResponse(t,e={}){if(!this.$res)return!1;e=this._initResponseOptions(e),this.$res.writeHead(e.status,e.headers),this.$res.end(t)}}class p extends f{constructor(t){super(t.req,t.res),this.$ctx=t}sendResponse(t,e={}){if(!this.$ctx)return!1;e=this._initResponseOptions(e),this.$ctx.status=e.status;for(let t in e.headers)this.$ctx.set(t,e.headers[t]);this.$ctx.body=t}}class h extends f{constructor(t,e){super(t,e)}sendResponse(t,e={}){if(!this.$res)return!1;e=this._initResponseOptions(e),this.$res.status(e.status).set(e.headers).send(t)}}const g={appKey:"",appSecret:""};var y=null;class m{constructor(t={}){if(this.$config=i({},g,t),!this.$config.appKey)throw new Error("\u672a\u586b\u5199appKey");if(!this.$config.appSecret)throw new Error("\u672a\u586b\u5199appSecret");y=this,this.$plugins.forEach(t=>{this[t].init(this)})}setAppServerDefault(t,e){this.$config.app=new f(t,e)}setAppServerKoa2(t){this.$config.app=new p(t)}setAppServerExpress(t,e){this.$config.app=new h(t,e)}}m.prototype.requestGet=(t=>new Promise((e,n)=>{r({method:"GET",uri:t},function(t,i,r){if(t)n(t);else{try{r=JSON.parse(r)}catch(t){}e(r)}})})),m.prototype.requestFile=(t=>new Promise((e,n)=>{r({method:"GET",uri:t,encoding:"binary"},function(t,i,r){t?n(t):e(r)})})),m.prototype.requestPost=((t,e=null)=>new Promise((n,i)=>{r({method:"POST",uri:t,json:e},function(t,e,r){t?i(t):n(r)})})),m.prototype.buildApiUrl=(t=>e(function*(){let e=yield y.access_token.getToken();return t+"?access_token="+e}())),m.prototype.$plugins=[],m.registPlugin=((t,e)=>{m.prototype[t]=e,m.prototype.$plugins.push(t)});var _={EasyWechat:m,getInstance:()=>y};const w="https://open.weixin.qq.com/connect/oauth2/authorize",b="https://open.weixin.qq.com/connect/qrconnect",q="https://api.weixin.qq.com/sns/oauth2/access_token",$="https://api.weixin.qq.com/sns/userinfo";class k{constructor(){this.id="",this.nickname="",this.name="",this.avatar="",this.original={},this.token={}}}const I=function(t){},v=function(t=""){let e=_.getInstance();if(!e.$config.oauth)return"";if(!e.$config.oauth.scope)throw new Error("\u672a\u586b\u5199\u6388\u6743scope");if(!e.$config.oauth.redirect)throw new Error("\u672a\u586b\u5199\u6388\u6743\u56de\u8c03\u5730\u5740");let n=e.$config.oauth.redirect;if("http://"!=n.substr(0,7)&&"https://"!=n.substr(0,8))throw new Error("\u8bf7\u586b\u5199\u5b8c\u6574\u7684\u56de\u8c03\u5730\u5740\uff0c\u4ee5\u201chttp://\u201d\u6216\u201chttps://\u201d\u5f00\u5934");let i=w;"snsapi_login"==e.$config.oauth.scope&&(i=b);let r={appid:e.$config.appKey,redirect_uri:n,response_type:"code",scope:e.$config.oauth.scope};return t&&(r.state=t),i+"?"+c.stringify(r)+"#wechat_redirect"},P=function(t){return e(function*(){let e=yield S(t);return"snsapi_base"!=_.getInstance().$config.oauth.scope&&(e=yield x(e)),e}())},S=function(t){return e(function*(){let e=_.getInstance(),n={appid:e.$config.appKey,secret:e.$config.appSecret,code:t,grant_type:"authorization_code"},i=q+"?"+c.stringify(n),r=yield e.requestGet(i),s=new k;return s.id=r.openid,s.token=r,s}())},x=function(t){return e(function*(){let e={access_token:t.token.access_token,openid:t.id,lang:"zh_CN"},n=$+"?"+c.stringify(e),i=yield _.getInstance().requestGet(n);return i.errcode?(console.log("oauth.fetchUserInfo()",i),!1):(t.id=i.openid,t.nickname=i.nickname,t.name=i.nickname,t.avatar=i.headimgurl,t.original=i,t)}())};var T={init:function(t){},redirect:function(t=""){let e=_.getInstance();if(!e.$config.oauth)return"";if(!e.$config.oauth.scope)throw new Error("\u672a\u586b\u5199\u6388\u6743scope");if(!e.$config.oauth.redirect)throw new Error("\u672a\u586b\u5199\u6388\u6743\u56de\u8c03\u5730\u5740");let n=e.$config.oauth.redirect;if("http://"!=n.substr(0,7)&&"https://"!=n.substr(0,8))throw new Error("\u8bf7\u586b\u5199\u5b8c\u6574\u7684\u56de\u8c03\u5730\u5740\uff0c\u4ee5\u201chttp://\u201d\u6216\u201chttps://\u201d\u5f00\u5934");let i=w;"snsapi_login"==e.$config.oauth.scope&&(i=b);let r={appid:e.$config.appKey,redirect_uri:n,response_type:"code",scope:e.$config.oauth.scope};return t&&(r.state=t),i+"?"+c.stringify(r)+"#wechat_redirect"},user:function(t){return e(function*(){let e=yield S(t);return"snsapi_base"!=_.getInstance().$config.oauth.scope&&(e=yield x(e)),e}())}};const A=function(){return parseInt((new Date).getTime()/1e3)},E=function(t=16){let e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n="";for(let i=0;i<t;i++)n+=e.charAt(Math.floor(Math.random()*e.length));return n},U=function(t){if(!t)return t;if("object"!=typeof t)return t;let e=new Object;for(let n in t)e[n]=U(t[n]);return e},M=function(){let t=arguments;if(0==t.length)return null;let e=U(t[0]);if(1==t.length)return e;for(let n=1;n<t.length;n++)if(t[n]&&"object"==typeof t[n])for(let i in t[n])e[i]=t[n][i];return e};var C={getTimestamp:function(){return parseInt((new Date).getTime()/1e3)},randomString:function(t=16){let e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n="";for(let i=0;i<t;i++)n+=e.charAt(Math.floor(Math.random()*e.length));return n},cloneObj:U,extendObj:function(){let t=arguments;if(0==t.length)return null;let e=U(t[0]);if(1==t.length)return e;for(let n=1;n<t.length;n++)if(t[n]&&"object"==typeof t[n])for(let i in t[n])e[i]=t[n][i];return e}};class j{constructor(){this.$options={}}fetch(t){return null}contains(t){return!0}save(t,e=null,n=0){return!0}delete(t){return!0}}class R extends j{constructor(){super(),this.$datas={}}fetch(t){return!this.contains(t)||this.$datas[t].lifeTime>0&&this.$datas[t].lifeTime<C.getTimestamp()?null:this.$datas[t].data}contains(t){return"object"==typeof this.$datas[t]}save(t,e=null,n=0){let i={data:e,lifeTime:n>0?n+C.getTimestamp():0};return this.$datas[t]=i,!0}delete(t){return delete this.$datas[t],!0}}class N extends j{constructor(t){super();let e={path:"",dirMode:511,fileMode:438,ext:".cache"};this.$options=C.extendObj(e,t),this.$options.path=u.resolve(this.$options.path);try{a.accessSync(this.$options.path,a.constants.R_OK&a.constants.W_OK)}catch(t){try{a.mkdirSync(this.$options.path,this.$options.dirMode)}catch(t){console.log("\u65e0\u6cd5\u521b\u5efa\u7f13\u5b58\u76ee\u5f55\uff1a"+this.$options.path,t)}}}getCacheFile(t){return this.$options.path+"/"+t+this.$options.ext}fetch(t){let e=null,n=this.getCacheFile(t);try{let t=JSON.parse(a.readFileSync(n,{encoding:"utf-8",flag:"r"}));e=t.lifeTime>0&&t.lifeTime<C.getTimestamp()?null:t.data}catch(t){console.log("\u65e0\u6cd5\u8bfb\u53d6\u7f13\u5b58\u6587\u4ef6\uff1a"+n,t),e=null}return e}contains(t){let e=this.getCacheFile(t);try{a.accessSync(e,a.constants.R_OK&a.constants.W_OK)}catch(t){return!1}return!0}save(t,e=null,n=0){let i=this.getCacheFile(t);try{let t={data:e,lifeTime:n>0?n+C.getTimestamp():0};a.writeFileSync(i,JSON.stringify(t),{mode:this.$options.fileMode,encoding:"utf-8",flag:"w"})}catch(t){return console.log("\u65e0\u6cd5\u5199\u5165\u7f13\u5b58\u6587\u4ef6\uff1a"+i,t),!1}return!0}delete(t){let e=this.getCacheFile(t);try{a.unlinkSync(e)}catch(t){return console.log("\u65e0\u6cd5\u5220\u9664\u7f13\u5b58\u6587\u4ef6\uff1a"+e,t),!1}return!0}}var D=Object.freeze({CacheInterface:j,MemoryCache:R,FileCache:N});const B=function(t){if(!t.$config.cache)switch(t.$config.cache_driver){case"file":t.$config.cache=new N(t.$config.cache_options);break;case"memory":default:t.$config.cache=new R}},O=function(t){t&&"function"==typeof t.fetch&&"function"==typeof t.contains&&"function"==typeof t.save&&"function"==typeof t.delete&&(_.getInstance().$config.cache=t)};var H={init:function(t){if(!t.$config.cache)switch(t.$config.cache_driver){case"file":t.$config.cache=new N(t.$config.cache_options);break;case"memory":default:t.$config.cache=new R}},setCache:function(t){t&&"function"==typeof t.fetch&&"function"==typeof t.contains&&"function"==typeof t.save&&"function"==typeof t.delete&&(_.getInstance().$config.cache=t)}};const K="https://api.weixin.qq.com/cgi-bin/token",W=function(t){t.$config.access_token_cache_key=t.$config.access_token_cache_key||"NODE_EASYWECHAT_ACCESS_TOKEN"},F=function(){return e(function*(){let t=_.getInstance(),e={appid:t.$config.appKey,secret:t.$config.appSecret,grant_type:"client_credential"},n=K+"?"+c.stringify(e);return yield t.requestGet(n)}())},z=function(t=!1){return e(function*(){let e=_.getInstance(),n=e.$config.cache.fetch(e.$config.access_token_cache_key);if(t||!n){let t=yield F();G(t.access_token,t.expires_in),n=t.access_token}return n}())},G=function(t,e=7200){let n=_.getInstance();console.log("\u5199\u5165AccessToken: ",n.$config.access_token_cache_key,t,e),n.$config.cache.save(n.$config.access_token_cache_key,t,e)};var Q={init:function(t){t.$config.access_token_cache_key=t.$config.access_token_cache_key||"NODE_EASYWECHAT_ACCESS_TOKEN"},getToken:function(t=!1){return e(function*(){let e=_.getInstance(),n=e.$config.cache.fetch(e.$config.access_token_cache_key);if(t||!n){let t=yield F();G(t.access_token,t.expires_in),n=t.access_token}return n}())},setToken:G},J="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},L=n(function(t,e){!function(n,i){t.exports=e=i()}(0,function(){var t=t||function(t,e){var n=Object.create||function(){function t(){}return function(e){var n;return t.prototype=e,n=new t,t.prototype=null,n}}(),i={},r=i.lib={},s=r.Base={extend:function(t){var e=n(this);return t&&e.mixIn(t),e.hasOwnProperty("init")&&this.init!==e.init||(e.init=function(){e.$super.init.apply(this,arguments)}),e.init.prototype=e,e.$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},o=r.WordArray=s.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=void 0!=e?e:4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words,n=t.words,i=this.sigBytes,r=t.sigBytes;if(this.clamp(),i%4)for(o=0;o<r;o++){var s=n[o>>>2]>>>24-o%4*8&255;e[i+o>>>2]|=s<<24-(i+o)%4*8}else for(var o=0;o<r;o+=4)e[i+o>>>2]=n[o>>>2];return this.sigBytes+=r,this},clamp:function(){var e=this.words,n=this.sigBytes;e[n>>>2]&=4294967295<<32-n%4*8,e.length=t.ceil(n/4)},clone:function(){var t=s.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var n,i=[],r=0;r<e;r+=4){var s=function(e){var e=e,n=987654321,i=4294967295;return function(){var r=((n=36969*(65535&n)+(n>>16)&i)<<16)+(e=18e3*(65535&e)+(e>>16)&i)&i;return r/=4294967296,(r+=.5)*(t.random()>.5?1:-1)}}(4294967296*(n||t.random()));n=987654071*s(),i.push(4294967296*s()|0)}return new o.init(i,e)}}),c=i.enc={},a=c.Hex={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],r=0;r<n;r++){var s=e[r>>>2]>>>24-r%4*8&255;i.push((s>>>4).toString(16)),i.push((15&s).toString(16))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i+=2)n[i>>>3]|=parseInt(t.substr(i,2),16)<<24-i%8*4;return new o.init(n,e/2)}},u=c.Latin1={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],r=0;r<n;r++){var s=e[r>>>2]>>>24-r%4*8&255;i.push(String.fromCharCode(s))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i++)n[i>>>2]|=(255&t.charCodeAt(i))<<24-i%4*8;return new o.init(n,e)}},l=c.Utf8={stringify:function(t){try{return decodeURIComponent(escape(u.stringify(t)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(t){return u.parse(unescape(encodeURIComponent(t)))}},d=r.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=l.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var n=this._data,i=n.words,r=n.sigBytes,s=this.blockSize,c=r/(4*s),a=(c=e?t.ceil(c):t.max((0|c)-this._minBufferSize,0))*s,u=t.min(4*a,r);if(a){for(var l=0;l<a;l+=s)this._doProcessBlock(i,l);var d=i.splice(0,a);n.sigBytes-=u}return new o.init(d,u)},clone:function(){var t=s.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0}),f=(r.Hasher=d.extend({cfg:s.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){d.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(e,n){return new t.init(n).finalize(e)}},_createHmacHelper:function(t){return function(e,n){return new f.HMAC.init(t,n).finalize(e)}}}),i.algo={});return i}(Math);return t})}),V=n(function(t,e){!function(n,i){t.exports=e=i(L)}(0,function(t){return function(){var e=t,n=e.lib,i=n.WordArray,r=n.Hasher,s=[],o=e.algo.SHA1=r.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){for(var n=this._hash.words,i=n[0],r=n[1],o=n[2],c=n[3],a=n[4],u=0;u<80;u++){if(u<16)s[u]=0|t[e+u];else{var l=s[u-3]^s[u-8]^s[u-14]^s[u-16];s[u]=l<<1|l>>>31}var d=(i<<5|i>>>27)+a+s[u];d+=u<20?1518500249+(r&o|~r&c):u<40?1859775393+(r^o^c):u<60?(r&o|r&c|o&c)-1894007588:(r^o^c)-899497514,a=c,c=o,o=r<<30|r>>>2,r=i,i=d}n[0]=n[0]+i|0,n[1]=n[1]+r|0,n[2]=n[2]+o|0,n[3]=n[3]+c|0,n[4]=n[4]+a|0},_doFinalize:function(){var t=this._data,e=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;return e[i>>>5]|=128<<24-i%32,e[14+(i+64>>>9<<4)]=Math.floor(n/4294967296),e[15+(i+64>>>9<<4)]=n,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=r.clone.call(this);return t._hash=this._hash.clone(),t}});e.SHA1=r._createHelper(o),e.HmacSHA1=r._createHmacHelper(o)}(),t.SHA1})});const Y="https://api.weixin.qq.com/cgi-bin/ticket/getticket",X=function(t){t.$config.jssdk_cache_key=t.$config.jssdk_cache_key||"NODE_EASYWECHAT_JSSKD_TICKET"};var Z="";const tt=function(t){Z=t},et=function(){return e(function*(){let t=_.getInstance(),e={access_token:yield t.access_token.getToken(),type:"jsapi"},n=Y+"?"+c.stringify(e);return yield t.requestGet(n)}())},nt=function(t,n=!1,i=!0){return e(function*(){let e=_.getInstance(),r=e.$config.cache.fetch(e.$config.jssdk_cache_key);if(!r){let t=yield et();console.log("\u5199\u5165JSSDK: ",e.$config.jssdk_cache_key,t.ticket,t.expires_in),e.$config.cache.save(e.$config.jssdk_cache_key,t.ticket,t.expires_in),r=t.ticket}let s=Z,o=C.randomString(),c=C.getTimestamp(),a=it({jsapi_ticket:r,noncestr:o,timestamp:c,url:s}),u={debug:n,appId:e.$config.appKey,timestamp:c,nonceStr:o,signature:a,url:s,jsApiList:t};return Z="",i?JSON.stringify(u):u}())},it=function(t){let e="",n="";for(let i in t)e+=n+i+"="+t[i],n="&";return V(e)};var rt={init:function(t){t.$config.jssdk_cache_key=t.$config.jssdk_cache_key||"NODE_EASYWECHAT_JSSKD_TICKET"},setUrl:function(t){Z=t},config:function(t,n=!1,i=!0){return e(function*(){let e=_.getInstance(),r=e.$config.cache.fetch(e.$config.jssdk_cache_key);if(!r){let t=yield et();console.log("\u5199\u5165JSSDK: ",e.$config.jssdk_cache_key,t.ticket,t.expires_in),e.$config.cache.save(e.$config.jssdk_cache_key,t.ticket,t.expires_in),r=t.ticket}let s=Z,o=C.randomString(),c=C.getTimestamp(),a=it({jsapi_ticket:r,noncestr:o,timestamp:c,url:s}),u={debug:n,appId:e.$config.appKey,timestamp:c,nonceStr:o,signature:a,url:s,jsApiList:t};return Z="",i?JSON.stringify(u):u}())}};class st{constructor(t){this.dataParams={ToUserName:"",FromUserName:"",CreateTime:C.getTimestamp(),MsgType:""},this.json=null,this.data="","object"==typeof t?this.json=t:this.data=t}setAttribute(t,e){this.dataParams[t]=e}formatData(){return"<xml>"+this._formatData(this.dataParams)+"</xml>"}_formatData(t){if("object"==typeof t){let e="";for(let n in t)e+=`<${n}>${this._formatData(t[n])}</${n}>`;return e}return"string"==typeof t?"<![CDATA["+t+"]]>":t}getData(){return this.json?JSON.stringify(this.json):(this.data||(this.data=this.formatData()),this.data)}}class ot extends st{constructor(t){super(""),this.dataParams.MsgType="text",this.dataParams.Content=t.content||""}content(t){this.dataParams.Content=t}}class ct extends st{constructor(t){super(""),this.dataParams.MsgType="image",this.dataParams.Image={MediaId:t.media_id||""}}mediaId(t){this.dataParams.Image.MediaId=t}}class at extends st{constructor(t){super(""),this.dataParams.MsgType="voice",this.dataParams.Voice={MediaId:t.media_id||""}}mediaId(t){this.dataParams.Voice.MediaId=t}}class ut extends st{constructor(t){super(""),this.dataParams.MsgType="video",this.dataParams.Video={MediaId:t.media_id||"",Title:t.title||"",Description:t.description||""}}mediaId(t){this.dataParams.Video.MediaId=t}title(t){this.dataParams.Video.Title=t}description(t){this.dataParams.Video.Description=t}}class lt extends st{constructor(t){super(""),this.dataParams.MsgType="music",this.dataParams.Music={MediaId:t.media_id||"",Title:t.title||"",Description:t.description||"",MusicUrl:t.music_url||"",HQMusicUrl:t.hq_music_url||"",ThumbMediaId:t.thumb_media_id||""}}mediaId(t){this.dataParams.Music.MediaId=t}title(t){this.dataParams.Music.Title=t}description(t){this.dataParams.Music.Description=t}musicUrl(t){this.dataParams.Music.MusicUrl=t}hqMusicurl(t){this.dataParams.Music.HQMusicUrl=t}thumbMediaId(t){this.dataParams.Music.ThumbMediaId=t}}class dt extends st{constructor(t){super(""),this.dataParams.MsgType="news",this.dataParams.ArticleCount=1,this.dataParams.Articles={item:{Title:t.title||"",Description:t.description||"",Url:t.url||"",PicUrl:t.image||""}}}title(t){this.dataParams.Articles.item.Title=t}description(t){this.dataParams.Articles.item.Description=t}url(t){this.dataParams.Articles.item.Url=t}picUrl(t){this.dataParams.Articles.item.PicUrl=t}}var ft=Object.freeze({Raw:st,Text:ot,Image:ct,Voice:at,Video:ut,Music:lt,News:dt});const pt=function(t){ht=function(){}};let ht,gt;const yt=function(t){"function"!=typeof t&&(t=function(){}),ht=t},mt=function(){return e(function*(){let t=_.getInstance(),e=t.$config.app;if(!e)throw new Error("\u672a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u5e94\u7528\u670d\u52a1\u5668");if("GET"==e.getMethod()){let n=e.getQuery();if(!(n.signature&&n.echostr&&n.timestamp&&n.nonce))return void e.sendResponse("Hello node-easywechat");let i=[n.nonce,n.timestamp,t.$config.token].sort();l.SHA1(i.join(""))===n.signature?e.sendResponse(n.echostr):e.sendResponse("fail")}else{let n=yield e.getBody();if(gt=yield _t(n,t.$config.aesKey),ht&&"function"==typeof ht){let t=yield ht(gt);if(!t||"string"==typeof t&&"SUCCESS"==t.toUpperCase())return void e.sendResponse("SUCCESS");let n=null;if((n="string"==typeof t?new ot({content:t}):t)&&"object"==typeof n){n.setAttribute("ToUserName",gt.FromUserName),n.setAttribute("FromUserName",gt.ToUserName);let t=n.getData();console.log("server.send()",t),e.sendResponse(t)}}}}())},_t=function(t,n){return e(function*(){return new Promise((e,i)=>{d.parseString(t,(t,r)=>{if(t)i(t);else{let t;if(r&&r.xml){t={};for(let e in r.xml)t[e]=r.xml[e][0];if(t.Encrypt&&n){let e=l.AES.decrypt(t.Encrypt,n).toString(l.enc.Utf8);console.log("decrypted",e)}}e(t)}})}).catch(t=>{console.log("server.parseMessage()",t)})}())},wt=function(){return gt};var bt={init:function(t){ht=function(){}},setMessageHandler:function(t){"function"!=typeof t&&(t=function(){}),ht=t},serve:function(){return e(function*(){let t=_.getInstance(),e=t.$config.app;if(!e)throw new Error("\u672a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u5e94\u7528\u670d\u52a1\u5668");if("GET"==e.getMethod()){let n=e.getQuery();if(!(n.signature&&n.echostr&&n.timestamp&&n.nonce))return void e.sendResponse("Hello node-easywechat");let i=[n.nonce,n.timestamp,t.$config.token].sort();l.SHA1(i.join(""))===n.signature?e.sendResponse(n.echostr):e.sendResponse("fail")}else{let n=yield e.getBody();if(gt=yield _t(n,t.$config.aesKey),ht&&"function"==typeof ht){let t=yield ht(gt);if(!t||"string"==typeof t&&"SUCCESS"==t.toUpperCase())return void e.sendResponse("SUCCESS");let n=null;if((n="string"==typeof t?new ot({content:t}):t)&&"object"==typeof n){n.setAttribute("ToUserName",gt.FromUserName),n.setAttribute("FromUserName",gt.ToUserName);let t=n.getData();console.log("server.send()",t),e.sendResponse(t)}}}}())},getMessage:function(){return gt}};const qt="https://api.weixin.qq.com/cgi-bin/message/template/send",$t="https://api.weixin.qq.com/cgi-bin/template/get_industry",kt="https://api.weixin.qq.com/cgi-bin/template/api_set_industry",It="https://api.weixin.qq.com/cgi-bin/template/api_add_template",vt="https://api.weixin.qq.com/cgi-bin/template/get_all_private_template",Pt="https://api.weixin.qq.com/cgi-bin/template/del_private_template",St=function(t){Tt=new xt};class xt{constructor(){this.reset()}}xt.prototype.reset=function(){this.touser="",this.template_id="",this.url="",this.miniprogram={},this.data=[]};let Tt=null;const At=function(t){return Tt.touser=t,this},Et=function(t){return Tt.template_id=t,this},Ut=function(t){return Tt.url=t,this},Mt=function(t){return Tt.data=Ct(t),this},Ct=function(t){let e={};for(let n in t){let i=t[n];"object"==typeof i?void 0!==i.length?e[n]={value:i[0],color:i[1]}:e[n]=i:e[n]={value:i}}return e},jt=function(t=null){return e(function*(){if(t?t.data&&(t.data=Ct(t.data)):t={},t=i({},Tt,t),Tt.reset(),!t.touser)throw new Error("\u7528\u6237openid\u4e3a\u7a7a");if(!t.template_id)throw new Error("\u6a21\u677fid\u4e3a\u7a7a");let e=_.getInstance(),n=yield e.buildApiUrl(qt);return yield e.requestPost(n,t)}())},Rt=function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl($t);return yield t.requestPost(e)}())},Nt=function(t,n){return e(function*(){let e=_.getInstance(),i=yield e.buildApiUrl(kt),r={industry_id1:t,industry_id2:n};return yield e.requestPost(i,r)}())},Dt=function(t){return e(function*(){let e=_.getInstance(),n=yield e.buildApiUrl(It),i={template_id_short:t};return yield e.requestPost(n,i)}())},Bt=function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(vt);return yield t.requestPost(e)}())},Ot=function(t){return e(function*(){let e=_.getInstance(),n=yield e.buildApiUrl(Pt),i={template_id:t};return yield e.requestPost(n,i)}())};var Ht={init:function(t){Tt=new xt},to:At,withTo:At,andTo:At,receiver:At,withReceiver:At,andhReceiver:At,uses:Et,withUses:Et,andUses:Et,template:Et,withTemplate:Et,andTemplate:Et,templateId:Et,withTemplateId:Et,andTemplateId:Et,url:Ut,withUrl:Ut,andUrl:Ut,link:Ut,withLink:Ut,andLink:Ut,linkTo:Ut,withLinkTo:Ut,andLinkTo:Ut,data:Mt,withData:Mt,andData:Mt,send:function(t=null){return e(function*(){if(t?t.data&&(t.data=Ct(t.data)):t={},t=i({},Tt,t),Tt.reset(),!t.touser)throw new Error("\u7528\u6237openid\u4e3a\u7a7a");if(!t.template_id)throw new Error("\u6a21\u677fid\u4e3a\u7a7a");let e=_.getInstance(),n=yield e.buildApiUrl(qt);return yield e.requestPost(n,t)}())},getIndustry:function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl($t);return yield t.requestPost(e)}())},setIndustry:function(t,n){return e(function*(){let e=_.getInstance(),i=yield e.buildApiUrl(kt),r={industry_id1:t,industry_id2:n};return yield e.requestPost(i,r)}())},addTemplate:function(t){return e(function*(){let e=_.getInstance(),n=yield e.buildApiUrl(It),i={template_id_short:t};return yield e.requestPost(n,i)}())},getPrivateTemplates:function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(vt);return yield t.requestPost(e)}())},deletePrivateTemplate:function(t){return e(function*(){let e=_.getInstance(),n=yield e.buildApiUrl(Pt),i={template_id:t};return yield e.requestPost(n,i)}())}};const Kt="https://api.weixin.qq.com/cgi-bin/qrcode/create",Wt="https://mp.weixin.qq.com/cgi-bin/showqrcode",Ft=function(t){},zt=function(t,n=null){return e(function*(){((n=parseInt(n))<=0||n>604800)&&(n=604800);let e="";"string"==typeof t?(t={scene_str:t},e="QR_STR_SCENE"):(t={scene_id:t},e="QR_SCENE");let i={expire_seconds:n,action_name:e,action_info:{scene:t}},r=_.getInstance(),s=yield r.buildApiUrl(Kt);return yield r.requestPost(s,i)}())},Gt=function(t){return e(function*(){let e="";"string"==typeof t?(t={scene_str:t},e="QR_LIMIT_STR_SCENE"):(t={scene_id:t},e="QR_LIMIT_SCENE");let n={action_name:e,action_info:{scene:t}},i=_.getInstance(),r=yield i.buildApiUrl(Kt);return yield i.requestPost(r,n)}())},Qt=function(t){return e(function*(){let e=Wt+"?ticket="+t;return yield _.getInstance().requestFile(e)}())};var Jt={init:function(t){},temporary:function(t,n=null){return e(function*(){((n=parseInt(n))<=0||n>604800)&&(n=604800);let e="";"string"==typeof t?(t={scene_str:t},e="QR_STR_SCENE"):(t={scene_id:t},e="QR_SCENE");let i={expire_seconds:n,action_name:e,action_info:{scene:t}},r=_.getInstance(),s=yield r.buildApiUrl(Kt);return yield r.requestPost(s,i)}())},forever:function(t){return e(function*(){let e="";"string"==typeof t?(t={scene_str:t},e="QR_LIMIT_STR_SCENE"):(t={scene_id:t},e="QR_LIMIT_SCENE");let n={action_name:e,action_info:{scene:t}},i=_.getInstance(),r=yield i.buildApiUrl(Kt);return yield i.requestPost(r,n)}())},url:function(t){return e(function*(){let e=Wt+"?ticket="+t;return yield _.getInstance().requestFile(e)}())}};const Lt="https://api.weixin.qq.com/cgi-bin/user/info",Vt="https://api.weixin.qq.com/cgi-bin/user/info/batchget",Yt="https://api.weixin.qq.com/cgi-bin/user/get",Xt="https://api.weixin.qq.com/cgi-bin/user/info/updateremark",Zt="https://api.weixin.qq.com/cgi-bin/tags/members/getblacklist",te="https://api.weixin.qq.com/cgi-bin/tags/members/batchblacklist",ee="https://api.weixin.qq.com/cgi-bin/tags/members/batchunblacklist";class ne{constructor(){this.id="",this.nickname="",this.name="",this.avatar="",this.original={},this.token={}}}const ie=function(t){},re=function(t,n="zh_CN"){return e(function*(){let e=_.getInstance(),i=yield e.buildApiUrl(Lt);i+="&openid="+t+"&lang="+n;let r=yield e.requestGet(i),s=new ne;return s.id=r.openid,s.nickname=r.nickname,s.name=r.nickname,s.avatar=r.headimgurl,s.original=r,s}())},se=function(t){return e(function*(){let e=_.getInstance(),n={user_list:t},i=yield e.buildApiUrl(Vt);return yield e.requestPost(i,n)}())},oe=function(t=null){return e(function*(){let e=_.getInstance(),n=yield e.buildApiUrl(Yt);return t&&(n+="&next_openid="+t),yield e.requestGet(n)}())},ce=function(t,n){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(Xt);return yield t.requestPost(e)}())},ae=function(t){return e(function*(){let e=_.getInstance(),n={};t&&(n.begin_openid=t);let i=yield e.buildApiUrl(Zt);return yield e.requestPost(i,n)}())},ue=function(t){return e(function*(){let e=_.getInstance(),n={openid_list:t},i=yield e.buildApiUrl(te);return yield e.requestPost(i,n)}())},le=function(t){return e(function*(){let e=_.getInstance(),n={openid_list:t},i=yield e.buildApiUrl(ee);return yield e.requestPost(i,n)}())},de=function(t){return e(function*(){return yield ue([t])}())},fe=function(t){return e(function*(){return yield le([t])}())};var pe={init:function(t){},get:function(t,n="zh_CN"){return e(function*(){let e=_.getInstance(),i=yield e.buildApiUrl(Lt);i+="&openid="+t+"&lang="+n;let r=yield e.requestGet(i),s=new ne;return s.id=r.openid,s.nickname=r.nickname,s.name=r.nickname,s.avatar=r.headimgurl,s.original=r,s}())},batchGet:function(t){return e(function*(){let e=_.getInstance(),n={user_list:t},i=yield e.buildApiUrl(Vt);return yield e.requestPost(i,n)}())},lists:function(t=null){return e(function*(){let e=_.getInstance(),n=yield e.buildApiUrl(Yt);return t&&(n+="&next_openid="+t),yield e.requestGet(n)}())},remark:function(t,n){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(Xt);return yield t.requestPost(e)}())},blacklist:function(t){return e(function*(){let e=_.getInstance(),n={};t&&(n.begin_openid=t);let i=yield e.buildApiUrl(Zt);return yield e.requestPost(i,n)}())},batchBlock:ue,batchUnblock:le,block:function(t){return e(function*(){return yield ue([t])}())},unblock:function(t){return e(function*(){return yield le([t])}())}};const he="https://api.weixin.qq.com/cgi-bin/menu/get",ge="https://api.weixin.qq.com/cgi-bin/get_current_selfmenu_info",ye="https://api.weixin.qq.com/cgi-bin/menu/create",me="https://api.weixin.qq.com/cgi-bin/menu/delete",_e=function(t){},we=function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(he);return yield t.requestPost(e)}())},be=function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(ge);return yield t.requestPost(e)}())},qe=function(t){return e(function*(){let e={button:t},n=_.getInstance(),i=yield n.buildApiUrl(ye);return yield n.requestPost(i,e)}())},$e=function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(me);return yield t.requestPost(e)}())};var ke={init:function(t){},all:function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(he);return yield t.requestPost(e)}())},current:function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(ge);return yield t.requestPost(e)}())},add:function(t){return e(function*(){let e={button:t},n=_.getInstance(),i=yield n.buildApiUrl(ye);return yield n.requestPost(i,e)}())},destroy:function(){return e(function*(){let t=_.getInstance(),e=yield t.buildApiUrl(me);return yield t.requestPost(e)}())}};const Ie="https://api.weixin.qq.com/cgi-bin/shorturl",ve=function(t){},Pe=function(t){return e(function*(){let e={action:"long2short",long_url:t},n=_.getInstance(),i=yield n.buildApiUrl(Ie);return yield n.requestPost(i,e)}())};var Se={init:function(t){},shorten:function(t){return e(function*(){let e={action:"long2short",long_url:t},n=_.getInstance(),i=yield n.buildApiUrl(Ie);return yield n.requestPost(i,e)}())}};_.EasyWechat.registPlugin("oauth",T),_.EasyWechat.registPlugin("cache",H),_.EasyWechat.registPlugin("access_token",Q),_.EasyWechat.registPlugin("jssdk",rt),_.EasyWechat.registPlugin("server",bt),_.EasyWechat.registPlugin("notice",Ht),_.EasyWechat.registPlugin("qrcode",Jt),_.EasyWechat.registPlugin("user",pe),_.EasyWechat.registPlugin("menu",ke),_.EasyWechat.registPlugin("url",Se),_.EasyWechat.Cache={};for(let t in D)_.EasyWechat.Cache[t]=D[t];_.EasyWechat.Message={};for(let t in ft)_.EasyWechat.Message[t]=ft[t];var xe=_.EasyWechat;module.exports=xe;